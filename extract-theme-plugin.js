const path = require('path')

function ExtractThemePlugin(options) {
    this.options = options
    // Setup the plugin instance with options...
}

ExtractThemePlugin.prototype.apply = function (compiler) {
    let THEME_CONFIG = {};
    compiler.plugin('compilation', (compilation) => {
        console.log('The compiler is starting a new compilation...');
        compilation.chunks.forEach(function (chunk) {
            // Explore each asset filename generated by the chunk:
            chunk.files.forEach(function (filename) {
                if (filename.indexOf('css/theme') !== -1) {

                    console.log(filename, '------')
                }
            });
        });
        compilation.plugin(
            'html-webpack-plugin-before-html-processing',
            (data) => {
                console.log(data, '-------')
                const areaJson = JSON.parse(data.plugin.assetJson);
                areaJson.forEach(outputPath => {
                    if (outputPath.indexOf('css/theme') !== -1) {
                        const match = outputPath.match(/(theme\w*)\./)[1];
                        THEME_CONFIG[match] = outputPath;
                    }
                })
                const scriptTag = `<script>window.THEME_CONFIG = ${JSON.stringify(THEME_CONFIG)}</script>`
                console.log(data.html, '-------------')
                data.html = data.html.toString().split('</head>')[0] + scriptTag + '</head>' + data.html.toString().split('<head>')[1]
            }
        )
    })
    /*  compiler.plugin('emit', function (compilation, callback) {
         // Explore each chunk (build output):
         compilation.chunks.forEach(function (chunk) {
             // Explore each asset filename generated by the chunk:
             chunk.files.forEach(function (filename) {
                 if (filename.indexOf('css/theme') !== -1) {
                    
                     console.log(filename, '------')
                 }
             });
         });
         callback();
     }); */



};


module.exports = ExtractThemePlugin;